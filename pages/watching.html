<!--
template: /templates/page.html
-->

<style>
  p {
    margin-bottom: 2rem;
  }
  h1 {
    margin-bottom: 2rem;
  }
  @media (min-width: 768px) {
    h1 {
      margin-bottom: 4rem;
    }
  }
</style>

<h1 class="text-large">Watching</h1>
<p id="chart-label">Number of films watched by month since January 2021:</p>
<svg role="img" id="chart" viewBox="0 0 600 400"></svg>

<script type="module">
  import {
    select,
    csv,
    timeParse,
    timeFormat,
    scaleLinear,
    max,
    min,
    maxIndex,
    minIndex,
    scaleBand,
    axisBottom,
    axisLeft,
    mean,
    format,
  } from "https://cdn.skypack.dev/d3@7";

  const svg = select("#chart");
  const viewBox = svg.attr("viewBox").split(" ");
  const width = +viewBox[2];
  const height = +viewBox[3];
  const margin = { top: 20, right: 20, bottom: 60, left: 20 };
  const innerWidth = width - margin.left - margin.right;
  const innerHeight = height - margin.top - margin.bottom;

  const render = (data) => {
    // value accessors
    const xValue = (d) => d.month;
    const yValue = (d) => d.count;

    const yScale = scaleLinear()
      .domain([max(data, yValue), 0])
      .range([0, innerHeight]);
    const xScale = scaleBand()
      .domain(data.map(xValue))
      .range([0, innerWidth])
      .padding(0.2);

    const g = svg
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);
    g.append("g")
      .call(axisBottom(xScale))
      .attr("transform", `translate(0, ${innerHeight})`);
    g.append("g").call(axisLeft(yScale));

    g.selectAll("rect")
      .data(data)
      .enter()
      .append("rect")
      .attr("x", (d) => xScale(xValue(d)))
      .attr("y", (d) => yScale(yValue(d)))
      .attr("height", (d) => innerHeight - yScale(yValue(d)))
      .attr("width", xScale.bandwidth())
      .attr("fill", "var(--primary)");

    // label
    const count = (d) => d.count;
    const average = format(".2r")(mean(data, count)); // format to 2 significant digits;
    const maxMonth = data[maxIndex(data, count)].month;
    const minMonth = data[minIndex(data, count)].month;
    const maxFilms = max(data, count);
    const minFilms = min(data, count);
    const label = `Since January 2021, I've watched on average ${average} films each monthâ€”at most ${maxFilms} films in a month (${maxMonth}) and as few as just ${minFilms} (${minMonth}).`;
    svg.attr("aria-label", label);
  };

  csv("/data/films.csv").then((data) => {
    const parseTime = timeParse("%Y-%m-%d");
    const formatTime = timeFormat("%b %y");
    const byMonth = data.reduce((acc, cur) => {
      const curMonth = formatTime(parseTime(cur.watchedOn));
      const accIndex = acc.findIndex((a) => a.month === curMonth);
      if (accIndex >= 0) {
        acc[accIndex].count += 1;
      } else {
        acc.push({ month: curMonth, count: 1 });
      }
      return acc;
    }, []);
    render(byMonth);
  });
</script>
