<!--
template: /templates/page.html
buildScript: /scripts/generateFilmsGrid.js
-->

<h1>Watching</h1>
<ul>
  <li>Films grid</li>
</ul>
<p>Number of films watched by month since January 2021:</p>
<svg role="img" id="chart" viewBox="0 0 600 400"></svg>

<script type="module">
  /**
   * Importing from d3 micropackages avoids loading unused ones like d3-geo
   * We use Skypack pinned URLs: https://docs.skypack.dev/skypack-cdn/api-reference/pinned-urls-optimized
   */
  import { select } from "https://cdn.skypack.dev/pin/d3-selection@v3.0.0-sAmQ3giCT8irML5wz1T1/mode=imports,min/optimized/d3-selection.js";
  import {
    timeParse,
    timeFormat,
  } from "https://cdn.skypack.dev/pin/d3-time-format@v4.1.0-f8eZV7eLtGIxvK8uvO3o/mode=imports,min/optimized/d3-time-format.js";
  import {
    max,
    min,
    maxIndex,
    minIndex,
  } from "https://cdn.skypack.dev/pin/d3-array@v3.1.1-Ibshj34oOmCw8da1RLSW/mode=imports,min/optimized/d3-array.js";
  import {
    scaleLinear,
    scaleBand,
  } from "https://cdn.skypack.dev/pin/d3-scale@v4.0.2-qUv67mnQQKwRMEsPRKcO/mode=imports,min/optimized/d3-scale.js";
  import {
    axisBottom,
    axisLeft,
  } from "https://cdn.skypack.dev/pin/d3-axis@v3.0.0-atdNID4TA9Y0wR53lsTq/mode=imports,min/optimized/d3-axis.js";

  const svg = select("#chart");
  const viewBox = svg.attr("viewBox").split(" ");
  const width = +viewBox[2];
  const height = +viewBox[3];
  const margin = { top: 20, right: 20, bottom: 60, left: 20 };
  const innerWidth = width - margin.left - margin.right;
  const innerHeight = height - margin.top - margin.bottom;

  function render(data) {
    // value accessors
    const xValue = (d) => d.month;
    const yValue = (d) => d.count;

    const yScale = scaleLinear()
      .domain([max(data, yValue), 0])
      .range([0, innerHeight]);
    const xScale = scaleBand()
      .domain(data.map(xValue))
      .range([0, innerWidth])
      .padding(0.2);

    const g = svg
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);
    g.append("g")
      .call(axisBottom(xScale))
      .attr("transform", `translate(0, ${innerHeight})`);
    g.append("g").call(axisLeft(yScale));

    g.selectAll("rect")
      .data(data)
      .enter()
      .append("rect")
      .attr("x", (d) => xScale(xValue(d)))
      .attr("y", (d) => yScale(yValue(d)))
      .attr("height", (d) => innerHeight - yScale(yValue(d)))
      .attr("width", xScale.bandwidth())
      .attr("fill", "currentColor");

    // label
    const count = (d) => d.count;
    const average = Math.round(
      data.reduce((acc, cur) => acc + cur.count, 0) / data.length
    );
    const maxMonth = data[maxIndex(data, count)].month;
    const minMonth = data[minIndex(data, count)].month;
    const maxFilms = max(data, count);
    const minFilms = min(data, count);
    const label = `Bar chart. Watched on average ${average} films per month. Max ${maxFilms} films in ${maxMonth}. Min ${minFilms} films in ${minMonth}.`;
    svg.attr("aria-label", label);
  }

  fetch("/films.json") // native fetch to avoid loading an extra d3 package
    .then((data) => data.json())
    .then((json) => {
      const parseTime = timeParse("%Y-%m-%d");
      const formatTime = timeFormat("%b %y");
      const byMonth = json.reduce((acc, cur) => {
        const curMonth = formatTime(parseTime(cur.watchDate));
        const accIndex = acc.findIndex((a) => a.month === curMonth);
        if (accIndex >= 0) {
          acc[accIndex].count += 1;
        } else {
          acc.push({ month: curMonth, count: 1 });
        }
        return acc;
      }, []);
      render(byMonth);
    });
</script>

<style>
  ul {
    padding: 0;
    list-style: none;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    grid-gap: var(--space-s);
    margin-bottom: var(--space-l);
  }
</style>
