<!--
template: /templates/page.html
title: Czechia
-->

<h1>Czechia <span aria-hidden="true">🇨🇿</span></h1>

<section id="currency">
  <h2><span aria-hidden="true">💶</span> CZK—EUR converter</h2>
  <form>
    <label for="amount">Amount (in CZK)</label>
    <input id="amount" type="number" />
    <button type="submit">Convert</button>
  </form>
  <p><span id="czk">1</span> CZK = <span id="eur">?</span> EUR</p>
</section>

<hr />

<section id="weather">
  <h2><span aria-hidden="true">☀️</span> Weather</h2>
  <form>
    <label for="city">City</label>
    <select id="city">
      <option value="prague">Prague</option>
      <option value="ceskyKrumlov">Cesky Krumlov</option>
      <option value="ceskeBudejovice">České Budějovice</option>
      <option value="telc">Telč</option>
      <option value="trebic">Třebíč</option>
      <option value="brno">Brno</option>
    </select>
    <button type="submit">Get forecast</button>
  </form>
  <h3 aria-live="polite">Not submitted</h3>
</section>

<script type="module">
  // elements
  const currencyFormEl = document.querySelector("#currency form"); // currency form
  const eurEl = document.getElementById("eur"); // printed euro value
  const czkEl = document.getElementById("czk"); // printed czk value
  const amountInputEl = document.getElementById("amount"); // amount input
  const weatherSectionEl = document.getElementById("weather");

  // globals
  let rate;

  // currency
  function handleCurrencySubmit(event) {
    event.preventDefault();
    const amount = amountInputEl.value;
    czkEl.innerText = amount;
    eurEl.innerText = (amount * rate).toFixed(2);
    currencyFormEl.reset();
  }
  async function getRate() {
    // we get rates from https://github.com/fawazahmed0/currency-api
    const response = await fetch(
      "https://cdn.jsdelivr.net/gh/fawazahmed0/currency-api@1/latest/currencies/czk/eur.json"
    );
    const data = await response.json();
    return data.eur;
  }

  // weather
  const CITIES = {
    prague: {
      name: "Prague",
      lat: 50.09,
      lon: 14.42,
    },
    ceskyKrumlov: {
      name: "Cesky Krumlov",
      lat: 48.81,
      lon: 14.32,
    },
    ceskeBudejovice: {
      name: "České Budějovice",
      lat: 48.97,
      lon: 14.48,
    },
    telc: {
      name: "Telč",
      lat: 49.18,
      lon: 15.45,
    },
    trebic: {
      name: "Třebíč",
      lat: 49.22,
      lon: 15.88,
    },
    brno: {
      name: "Brno",
      lat: 49.19,
      lon: 16.61,
    },
  };
  async function handleWeatherSubmit(event) {
    event.preventDefault();
    // get value
    const city = document.getElementById("city").value;
    // get weather
    const weather = await getWeather(CITIES[city] || CITIES.prague); // default to prague
    // render forecast title
    document.querySelector("#weather h3").innerText = `${getWeatherIcon(
      weather.current.weather[0].id
    )} ${weather.current.weather[0].description} in ${CITIES[city].name}`;
    // clear previous tables
    document.querySelectorAll("table").forEach((table) => table.remove());
    // set up hours table
    const hoursTableEl = document.createElement("table");
    const hoursCaption = document.createElement("caption");
    hoursCaption.innerText = "Hourly forecast";
    hoursTableEl.appendChild(hoursCaption);
    const hourRow = document.createElement("tr");
    hoursTableEl.appendChild(hourRow);
    const hourIconRow = document.createElement("tr");
    hoursTableEl.appendChild(hourIconRow);
    const hourTempRow = document.createElement("tr");
    hoursTableEl.appendChild(hourTempRow);
    // fill hours table
    const hours = [0, 3, 6, 9, 12];
    hours.forEach((h) => {
      // hour header cell
      const hourEl = document.createElement("th");
      hourEl.innerText = new Date(weather.hourly[h].dt * 1000).getHours() + "h";
      hourRow.appendChild(hourEl);
      // icon cell
      const iconEl = document.createElement("td");
      iconEl.innerText = getWeatherIcon(weather.hourly[h].weather[0].id);
      iconEl.setAttribute(
        "aria-label",
        weather.hourly[h].weather[0].description
      );
      hourIconRow.appendChild(iconEl);
      // temp cell
      const tempEl = document.createElement("td");
      tempEl.innerText = Math.round(weather.hourly[h].temp) + "°C";
      hourTempRow.appendChild(tempEl);
    });
    // set up days table
    const daysTableEl = document.createElement("table");
    const daysCaption = document.createElement("caption");
    daysCaption.innerText = "Daily forecast";
    daysTableEl.appendChild(daysCaption);
    const dayRow = document.createElement("tr");
    daysTableEl.appendChild(dayRow);
    const dayIconRow = document.createElement("tr");
    daysTableEl.appendChild(dayIconRow);
    const dayTempRow = document.createElement("tr");
    daysTableEl.appendChild(dayTempRow);
    // fill days table
    const days = [0, 1, 2, 3, 4];
    days.forEach((d) => {
      // day header cell
      const dayEl = document.createElement("th");
      dayEl.innerText = new Date(weather.daily[d].dt * 1000).getDate();
      dayRow.appendChild(dayEl);
      // icon cell
      const iconEl = document.createElement("td");
      iconEl.innerText = getWeatherIcon(weather.daily[d].weather[0].id);
      iconEl.setAttribute(
        "aria-label",
        weather.daily[d].weather[0].description
      );
      dayIconRow.appendChild(iconEl);
      // temp cell
      const tempEl = document.createElement("td");
      tempEl.innerText = Math.round(weather.daily[d].temp.day) + "°C";
      dayTempRow.appendChild(tempEl);
    });
    // render
    weatherSectionEl.appendChild(hoursTableEl);
    weatherSectionEl.appendChild(daysTableEl);
  }
  async function getWeather(city) {
    const response = await fetch(
      `https://owm.robinmetral.workers.dev/?lat=${city.lat}&lon=${city.lon}`
    );
    const data = await response.json();
    return data;
  }
  // https://openweathermap.org/weather-conditions#Weather-Condition-Codes-2
  function getWeatherIcon(iconId) {
    switch (true) {
      case iconId === 804:
        return "☁️";
      case iconId === 803 || iconId === 802:
        return "⛅";
      case iconId === 801:
        return "🌤️";
      case iconId === 800:
        return "☀️";
      case iconId === 781:
        return "🌪️";
      case iconId >= 700:
        return "🌫️";
      case iconId >= 600:
        return "🌨️";
      case iconId >= 300:
        return "🌧️";
      case iconId >= 200:
        return "🌩️";
    }
  }

  async function init() {
    // get conversion rate (save in global scope)
    rate = await getRate();
    // render default conversion for 1 CZK
    eurEl.innerText = rate;
    // wire up forms
    currencyFormEl.onsubmit = handleCurrencySubmit;
    document.querySelector("#weather form").onsubmit = handleWeatherSubmit;
  }
  init();
</script>

<style>
  section > * {
    margin-bottom: var(--space-m);
  }
  form {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-xs);
  }
</style>
